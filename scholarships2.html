<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scholarships Browser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="nav.css">
  <style>
    header { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin: 14px 20px; }
    h1 { font-size: 22px; margin: 0 10px 0 0; }
    .controls { display:flex; flex-wrap: wrap; gap: 10px; margin: 0 20px; }
    input, select { padding: 8px 10px; font-size: 14px; min-width: 200px; }
    #count { font-size: 13px; }
    /* Match scholarships_data.html table styling */
    .styled-table {
      border-collapse: collapse;
      margin: 25px 20px;
      font-size: 18px;
      font-family: Arial, sans-serif;
      min-width: 400px;
      width: 100%;
      table-layout: fixed;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    }
    .styled-table thead tr { background-color: #004080; color: #ffffff; text-align: center; }
    .styled-table th { text-align: center; white-space: nowrap; }
    .styled-table td { white-space: nowrap; }
    .styled-table td.title { white-space: normal; overflow-wrap: anywhere; }
    .styled-table td.desc { white-space: normal; overflow-wrap: anywhere; }
    .styled-table td.days, .styled-table th.days { text-align: center; }
    .styled-table th, .styled-table td { border: 1px solid #dddddd; padding: 12px 15px; }
    .styled-table tbody tr { background-color: #000000 !important; }
    .styled-table tbody tr:nth-of-type(even) { background-color: #030303 !important; }
    .styled-table tbody tr:last-of-type { border-bottom: 2px solid #004080; }
    .styled-table tbody tr td { color: #ffffff !important; }
    .styled-table tbody tr:hover { background-color: #1a1a8c; }
    footer { margin: 14px 20px; font-size: 12px; }
  </style>
</head>
<body>
  <ul>
    <li><a href="Meet_the_Counselor.html">Meet the Counselor</a></li>
    <li class="dropdown">
      <a href="KeyTakeAways.html" class="dropbtn">Key Take Aways</a>
      <div class="dropdown-content">
        <a href="scholarships_data.html">Scholarships</a>
        <a href="CareeerDevelopmentAssignmentApplytoWashUCollegePrep.html">College Enrichment and Access Programs</a>
        <a href="SummerBioSciencePrograms-Internships.html">Internships</a>
      </div>
    </li>
    <li><a href="SideProjects.html">Side Projects</a></li>
    <li><a href="https://stlps-my.sharepoint.com/:o:/g/personal/es26024_slps_org/EmDPav8SGkBJpOQDvNvqxIQBBPr6l887ejscvm4YUOVx4A?e=5vErMc" target="_blank">Resource Repository</a></li>
    <li><a href="EverettStuckeyResume%20Data.pdf">CV</a></li>
  </ul>

  <header>
    <h1>Scholarships</h1>
    <div id="count">Loading…</div>
  </header>

  <div class="controls">
    <input id="q" placeholder="Search title or provider…" />
    <select id="deadline">
      <option value="">Any deadline</option>
      <option value="30">Next 30 days</option>
      <option value="60">Next 60 days</option>
      <option value="90">Next 90 days</option>
    </select>
  </div>

  <div id="results"></div>

  <footer>
    Data from scholarships/automated/scholarships.db (client-side, read-only).
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    (async function() {
      const SQL = await initSqlJs({
        locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`
      });

      const qEl = document.getElementById('q');
      const dEl = document.getElementById('deadline');
      const resEl = document.getElementById('results');
      const countEl = document.getElementById('count');

      // Load the SQLite DB
      let db;
      try {
        const dbBytes = await fetch('scholarships/automated/scholarships.db').then(r => {
          if (!r.ok) throw new Error('Unable to load database file');
          return r.arrayBuffer();
        });
        db = new SQL.Database(new Uint8Array(dbBytes));
      } catch (e) {
        console.error(e);
        countEl.textContent = 'Failed to load database.';
        resEl.innerHTML = '<div class="meta">Unable to load the database file. Please refresh or try again later.</div>';
        return;
      }

      qEl.addEventListener('input', render);
      dEl.addEventListener('change', render);

      render();

      function render() {
        const q = (qEl.value || '').trim().toLowerCase();
        const days = (dEl.value || '').trim();

        let sql = `
          SELECT title, url, deadline_date, deadline_text, amount_text, amount_min, amount_max, description
          FROM scholarships
          WHERE 1=1
        `;
        const params = [];

        if (q) {
          sql += " AND (LOWER(COALESCE(title,'')) LIKE ? OR LOWER(COALESCE(provider,'')) LIKE ?)";
          params.push('%' + q + '%', '%' + q + '%');
        }

        // Exclude past deadlines (allow today and future, and keep NULL/unknown)
        const today = new Date();
        const t = today.toISOString().slice(0,10);
        sql += " AND (deadline_date IS NULL OR deadline_date = '' OR deadline_date >= ?)";
        params.push(t);

        if (days) {
          const cut = new Date(Date.now() + Number(days) * 24 * 3600 * 1000);
          const c = cut.toISOString().slice(0,10);
          sql += " AND deadline_date <= ?";
          params.push(c);
        }
        sql += " ORDER BY CASE WHEN deadline_date IS NULL OR deadline_date = '' THEN '9999-12-31' ELSE deadline_date END ASC";

        let rows = [];
        try {
          const res = db.exec(sql, params);
          rows = (res[0]?.values) || [];
        } catch (e) {
          console.error(e);
          countEl.textContent = 'Query error.';
          resEl.innerHTML = '<div class="meta">Query failed. Please adjust your filters or reload.</div>';
          return;
        }

        countEl.textContent = rows.length + " result" + (rows.length === 1 ? "" : "s");

        const rowsHtml = rows.map(r => {
          const title = escapeHtml(r[0] || '');
          const url = escapeAttr(r[1] || '#');
          const dISO = r[2] || null; // YYYY-MM-DD
          const dTextRaw = r[3] || '';
          const amtText = (r[4] || '').toString().trim();
          const min = (r[5] !== null && r[5] !== '') ? Number(r[5]) : null;
          const max = (r[6] !== null && r[6] !== '') ? Number(r[6]) : null;
          const rawDesc = (r[7] || '').toString();

          const due = dISO ? fmtDate(dISO) : escapeHtml(dTextRaw || '');
          const days = dISO ? daysUntil(dISO) : '';

          let amountDisp = amtText;
          if (!amountDisp) {
            if (min && max) amountDisp = `$${min.toLocaleString()} - $${max.toLocaleString()}`;
            else if (min) amountDisp = `$${min.toLocaleString()}`;
            else if (max) amountDisp = `$${max.toLocaleString()}`;
            else amountDisp = '';
          }
          const amount = escapeHtml(amountDisp);
          const desc = escapeHtml(truncate(rawDesc, 280));

          return `
            <tr>
              <td class="days">${days}</td>
              <td>${amount}</td>
              <td class="title"><a href="${url}" target="_blank" rel="noopener">${title}</a></td>
              <td class="desc">${desc}</td>
              <td>${due}</td>
            </tr>
          `;
        }).join('');

        if (!rowsHtml) {
          resEl.innerHTML = '<div class="meta">No matches.</div>';
        } else {
          resEl.innerHTML = `
            <div class="table-wrap">
              <table class="dataframe styled-table">
                <colgroup>
                  <col style="width: 7.2%;">
                  <col style="width: 4.8%;">
                  <col style="width: 18%;">
                  <col style="width: 60%;">
                  <col style="width: 10%;">
                </colgroup>
                <thead>
                  <tr>
                    <th class="days">Days til due</th>
                    <th>Amount</th>
                    <th>Scholarship Title</th>
                    <th>Description</th>
                    <th>Due Date</th>
                  </tr>
                </thead>
                <tbody>
                  ${rowsHtml}
                </tbody>
              </table>
            </div>
          `;
        }
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      function escapeAttr(s) {
        return escapeHtml(s).replace(/"/g, "&quot;");
      }
      function daysUntil(iso) {
        try {
          const today = new Date();
          const t = new Date(today.toISOString().slice(0,10));
          const d = new Date(iso);
          const ms = d - t;
          const days = Math.ceil(ms / 86400000);
          return isFinite(days) ? days : '';
        } catch (_) { return ''; }
      }
      function fmtDate(iso) {
        try {
          const [y, m, d] = String(iso).split('-');
          if (y && m && d) return `${m}-${d}-${y}`;
          return iso;
        } catch (_) { return iso; }
      }
      function truncate(s, n) {
        try {
          const str = String(s || '');
          return str.length > n ? str.slice(0, Math.max(0, n - 1)) + '…' : str;
        } catch (_) { return s; }
      }
    })();
  </script>
</body>
</html>
